# Media Video Maker Server

Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾ Ð¸Ð· Ñ„Ð¾Ñ‚Ð¾ Ð¸/Ð¸Ð»Ð¸ Ð²Ð¸Ð´ÐµÐ¾. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ REST API Ð¸ MCP Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ AI Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð°Ð¼Ð¸.

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### Ð¢Ð¾Ñ‡ÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð° ÑÐµÑ€Ð²Ð¸ÑÐ°:
- **REST API**: `http://localhost:4123` (Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ€Ð²Ð¸Ñ)
- **MCP Server**: `http://localhost:5123` (Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ AI)

### ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:
```bash
# ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°
MEDIA_PORT=4123                    # REST API Ð¿Ð¾Ñ€Ñ‚
LOG_LEVEL=info                     # debug|info|warn|error

# ÐŸÐ°Ð¿ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…  
OUTPUT_DIR=/app/output             # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ð¸Ð´ÐµÐ¾
ASSETS_DIR=/root/media-video-maker_project  # Ð ÐµÑÑƒÑ€ÑÑ‹
PROJECT_ROOT=/root/media-video-maker_project # ÐšÐ¾Ñ€ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

# TTS ÑÐµÑ€Ð²Ð¸ÑÑ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ)
KOKORO_TTS_URL=http://localhost:11402/v1/tts  # Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Kokoro  
OPENAI_API_KEY=sk-...                        # OpenAI ÐºÐ»ÑŽÑ‡
OPENAI_BASE_URL=https://api.openai.com/v1     # OpenAI endpoint

# Ð¨Ñ€Ð¸Ñ„Ñ‚Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
FONT_FILE=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf
```

### Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð¼Ð°Ð½Ð´:

#### Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°:
```bash
npm run dev          # Ð—Ð°Ð¿ÑƒÑÐº Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ ts-node
npm run build        # Ð¡Ð±Ð¾Ñ€ÐºÐ° TypeScript â†’ dist/
npm run check        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð¾Ð² Ð±ÐµÐ· ÑÐ±Ð¾Ñ€ÐºÐ¸  
npm run start        # Ð—Ð°Ð¿ÑƒÑÐº production ÑÐ±Ð¾Ñ€ÐºÐ¸
```

#### Docker (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½):
```bash
docker build -t media-video-maker .
docker run -it --rm \
  -e LOG_LEVEL=debug \
  -e PORT=4123 \
  -p 4123:4123 \
  -v /root/video_factory/assets:/app/data:ro \
  -v /root/video_factory/videos:/app/output \
  media-video-maker
```

#### ÐŸÑ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:
```bash
# Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²Ð°  
cd /root/media-video-maker_project/media-video-maker_server
git pull origin main
npm run build
nohup node dist/media-server.js > server.log 2>&1 &

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°
ps aux | grep media-server
curl http://localhost:4123/api/health
```

## Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹

ÐŸÑ€Ð¾ÐµÐºÑ‚ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‘Ð½ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»Ð¸: **subtitles** (ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ñ‹), **voiceover** (Ð¾Ð·Ð²ÑƒÑ‡ÐºÐ°), **overlays** (Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð½Ð°ÐºÐ»Ð°Ð´ÐºÐ¸), **music** (Ñ„Ð¾Ð½Ð¾Ð²Ð°Ñ Ð¼ÑƒÐ·Ñ‹ÐºÐ°).

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²
```
media-video-maker_server/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ input/          # Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
â”‚   â”œâ”€â”€ output/         # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð² (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Git)
â”‚   â”œâ”€â”€ run_all_tests.sh   # Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð²
â”‚   â”œâ”€â”€ test_subtitles.sh  # Ð¢ÐµÑÑ‚ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ð¾Ð²
â”‚   â”œâ”€â”€ test_voiceover.sh  # Ð¢ÐµÑÑ‚ Ð¾Ð·Ð²ÑƒÑ‡ÐºÐ¸
â”‚   â”œâ”€â”€ test_overlays.sh   # Ð¢ÐµÑÑ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð½Ð°ÐºÐ»Ð°Ð´Ð¾Ðº
â”‚   â””â”€â”€ test_music.sh      # Ð¢ÐµÑÑ‚ Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¹ Ð¼ÑƒÐ·Ñ‹ÐºÐ¸
â”œâ”€â”€ logs/               # Ð›Ð¾Ð³Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Git)
â””â”€â”€ modules/            # ÐŸÐ°Ð¿ÐºÐ¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
    â”œâ”€â”€ subtitles/
    â”œâ”€â”€ voiceover/
    â”œâ”€â”€ overlays/
    â””â”€â”€ music/
```

### Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²

#### Ð’ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÑÑ€Ð°Ð·Ñƒ:
```bash
cd media-video-maker_server
./tests/run_all_tests.sh
```

#### ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ:
```bash
./tests/test_subtitles.sh
./tests/test_voiceover.sh      # Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ OPENAI_API_KEY
./tests/test_overlays.sh
./tests/test_music.sh
```

### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ **Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ð°** (Ð½Ðµ Ð¸Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ)
- Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² `tests/output/`
- Ð›Ð¾Ð³Ð¸ Ð¿Ð¸ÑˆÑƒÑ‚ÑÑ Ð² `logs/module_name.log`
- Ð¢ÐµÑÑ‚ ÑƒÑÐ¿ÐµÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚

### Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
- Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° `http://127.0.0.1:4123`
- Ð”Ð»Ñ `test_voiceover.sh`: ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `OPENAI_API_KEY` Ð² env
- FFmpeg Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²

## ðŸ“¡ API Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹

### Health Check:
```bash
curl http://localhost:4123/api/health
# ÐžÑ‚Ð²ÐµÑ‚: {"status":"ok","timestamp":"2025-10-03T16:30:00.000Z","uptime":12345}
```

### Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ð´ÐµÐ¾:
```bash
curl -X POST http://localhost:4123/api/create-video \
  -H 'Content-Type: application/json' \
  -d '{
    "files": [{"id": "img1", "src": "/path/to/image.jpg", "type": "photo"}],
    "width": 640,
    "height": 360,
    "durationPerPhoto": 2.0
  }'
# ÐžÑ‚Ð²ÐµÑ‚: {"id": "uuid-here", "status": "queued", "progress": 0}
```

### Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:
```bash
curl http://localhost:4123/api/status/JOB_UUID_HERE
# ÐžÑ‚Ð²ÐµÑ‚: {"id": "uuid", "status": "completed", "output": "/path/to/video.mp4"}
```

### Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹:
```bash
curl http://localhost:4123/api/diagnostic
# ÐžÑ‚Ð²ÐµÑ‚: Ð±Ð»Ð¾Ðº Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
```

## ðŸ”§ Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¸ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°

### Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:

#### Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ:
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
netstat -tulpn | grep :4123

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
tail -f server.log

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° TypeScript Ð¾ÑˆÐ¸Ð±Ð¾Ðº
npm run check
```

#### Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹ 400:
- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð² JSON ÑÑ…ÐµÐ¼Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `type: "photo"` (Ð½Ðµ `image`)

#### TTS Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ `OPENAI_API_KEY` Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ `KOKORO_TTS_URL`

#### ÐÐµÑ‚ Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ:
```bash
df -h                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼ÐµÑÑ‚Ð°
du -sh /app/output/     # Ð Ð°Ð·Ð¼ÐµÑ€ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
```

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²:
```bash
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼
ps aux | grep media-server

# ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
curl http://localhost:4123/api/jobs

# Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
curl http://localhost:4123/api/diagnostic | jq '.system'
```

## ðŸ”„ Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:
```
src/
â”œâ”€â”€ media-server.ts          # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€  
â”œâ”€â”€ server/                  # HTTP Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
â”œâ”€â”€ pipeline/                # Ð’Ð¸Ð´ÐµÐ¾ ÐºÑ€Ð°Ð½Ñ‡Ð¸Ð½Ð³Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
â”œâ”€â”€ audio/                   # TTS Ð¸ Ð°ÑƒÐ´Ð¸Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
â”œâ”€â”€ utils/                   # Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ (Ð»Ð¾Ð³Ð¸, Ñ„Ð°Ð¹Ð»Ñ‹, Ð¿Ð°Ð¿ÐºÐ¸)
â””â”€â”€ types/                   # TypeScript Ñ‚Ð¸Ð¿Ñ‹
```

### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸:
- Ð’ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² feature Ð²ÐµÑ‚ÐºÐ°Ñ… (`feature/module/short_desc`)
- ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð¼Ð¾Ð´ÑƒÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
- ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² `ÐÐ½Ð°Ð»Ð¸Ð·_Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°/` Ñ Ð´Ð°Ñ‚Ð¾Ð¹/Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
- ÐÐ° ÑÐµÑ€Ð²ÐµÑ€ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð· `main`

### ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€:
```bash
ssh root@178.156.142.35
cd /root/media-video-maker_project  
git pull origin main
npm run build
pkill -f media-server
nohup node dist/media-server.js > server.log 2>&1 &
```
