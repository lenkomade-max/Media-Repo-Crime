# Полный реальный аудит репозитория и исправление проблем (НЕ симуляция)

Цель: провести реальный, воспроизводимый и проверяемый аудит проекта, найти и подтвердить проблемы, подготовить конкретные правки/исправления и зафиксировать результаты. Работай пошагово, показывай все команды и их реальные выводы. Не придумывай.

Контекст:
- Операционная система: macOS (darwin 24.6.0)
- Рабочая директория репозитория: /Users/user/media-video-maker
- Используй абсолютные пути в командах.
- Проект содержит серверную часть в `media-video-maker_server/` и множество JSON/скриптов.

Правила (строго):
1) Никаких предположений без проверки. Все выводы подтверждай командами, логами или ссылками на файлы.
2) Показывай реальные команды и полный реальный вывод (сокращай только очевидный шум, отмечая место сокращения).
3) Любые изменения — только через аккуратные правки файлов с чётким диффом. Никакой «симуляции выполнения».
4) Если команда требует интерактивного ввода — используй неинтерактивные флаги или явно укажи, что нужно от пользователя.
5) Если чего‑то не хватает (зависимости/секреты/сервисы) — зафиксируй препятствие, предложи варианты решения и продолжи по областям, где можно работать.

Обязательные действия (выполняй по порядку):
A. Инвентаризация репозитория
- Перечисли структуру ключевых директорий и артефактов:
  - `media-video-maker_server/`
  - Все `*.json` конфигурации в корне
  - Скрипты `*.sh` и `*.py`
- Для каждого важного узла — кратко опиши назначение (по коду/README).

B. Проверка состояния git
- Выполни: `cd /Users/user/media-video-maker && git status && git log -n 5 --oneline`
- Зафиксируй незакоммиченные изменения, удалённые/новые файлы (особенно `.cursor/*`, изменённые тестовые JSON).

C. Статический анализ и поиск ошибок
- Быстрый поиск очевидных проблем:
  - `rg -n "TODO|FIXME|BUG|HACK|XXX" /Users/user/media-video-maker`
  - `rg -n "console\.error|throw new|error\(|Exception" /Users/user/media-video-maker`
- Для TypeScript/Node частей:
  - Если есть `package.json` в `media-video-maker_server/` — выполни `npm ci` или `pnpm i --frozen-lockfile` (без интерактива). Затем `npm run build` и/или `tsc -p .`.
  - Покажи все ошибки типов/сборки.
- Для Python утилит:
  - Активируй venv, если есть. Иначе укажи требования из `requirements.txt` под `n8n_autonomous_system/` и установи в изолированную среду. Затем `python -m pyflakes`/`ruff` если доступно, или укажи отсутствие.

D. Запуск скриптов диагностики из репозитория
- Попробуй выполнить безопасные скрипты проверки (без разрушительных действий):
  - `/Users/user/media-video-maker/check-assets-and-ports.sh` (если требует sudo — пропусти и объясни)
  - `/Users/user/media-video-maker/check-servers.sh`
- Покажи реальный вывод.

E. Проверка серверной части
- Если есть локальный сервер:
  - Найди точку входа в `media-video-maker_server/` (например, `npm run dev`/`start`).
  - Запусти в фоне, зафиксируй порт, логи старта, ошибки. Затем останови.
  - Если запуска нет — зафиксируй причину (нет `package.json`, скриптов, зависимостей).

F. Поиск проблем совместимости и конфигурации
- Проверка Node версии: `node -v` и соответствие `engines` (если есть).
- Проверка переменных окружения: перечисли, что требуется по коду (поиск `process.env.` / `.env`). Укажи, чего не хватает.
- Проверка прав доступа файлов/скриптов: `ls -la` важного.

G. Анализ JSON‑workflow и тестовых нагрузок
- Просмотри ключевые `*.json` (например, `working-crime-workflow.json`, `perfect-n8n-workflow.json`, `test_payload.json`, `final_test_payload.json`).
- Проверь валидность JSON: `jq . <file>`; отметь ошибки.
- Сопоставь зависимости между workflow и скриптами.

H. Безопасность и секреты
- Поиск случайно закоммиченных ключей/секретов (паттерны `API_KEY|TOKEN|SECRET`), укажи находки.
- Укажи потенциальные риски (исполняемые скрипты, сетевые вызовы, загрузка в GDrive и т.д.).

I. Подготовка конкретных исправлений
- Для каждой подтверждённой проблемы:
  - Опиши причину и влияние.
  - Предложи минимальное исправление и альтернативу.
  - Приведи дифф правки (минимальный контекст), готовый к применению.
  - Если нужно добавить/обновить скрипт — приведи целиком файл.

J. Верификация исправлений
- Опиши, как проверить исправление локально: команды запуска, ожидаемые логи/результаты.
- Если проверка невозможна (нет сервиса/секрета) — предложи процедуру с заглушками.

Выводы/артефакты (обязательные):
1) Краткий отчёт‑резюме (10–15 пунктов): основные риски и приоритеты.
2) Детальный отчёт с доказательствами: команды, выводы, ссылки на файлы/строки кода.
3) Список задач к выполнению (приоритезированный), каждая задача — измеримый результат.
4) Набор диффов/правок, готовых к применению, либо инструкции для полуавтоматического применения.

Формат ответа:
- Разделы в порядке A→J + Артефакты.
- Команды выделяй блоками, сразу под ними — полный реальный вывод.
- Ссылки на код показывай как `файл:строка-строка` и цитируй короткие фрагменты.
- Для диффов используй минимальные, понятные контексты.

Если что‑то блокирует шаг — явно фиксируй блокер и переходи к следующему проверяемому шагу. Не симулируй выполнение — показывай только то, что действительно сделал и видишь.