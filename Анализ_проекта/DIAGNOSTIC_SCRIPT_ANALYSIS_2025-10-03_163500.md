# 2025-10-03 16:35:00 - Анализ скрипта диагностики окружения и health

## Созданный скрипт диагностики: `scripts/diagnostic.sh`

### ✅ Полная функциональность скрипта

#### 1. СИСТЕМНАЯ ДИАГНОСТИКА  
- ✅ **Операционная система**: версия, архитектура через `uname`
- ✅ **Память**: использование RAM через `free -m`
- ✅ **Дисковое пространство**: свободное место через `df -h`
- ✅ **Цветной вывод**: RED/GREEN/YELLOW/BLUE для разных типов сообщений

#### 2. RUNTIME КОМПОНЕНТЫ
- ✅ **Node.js**: версия и доступность  
- ✅ **NPM**: версия package manager
- ✅ **FFmpeg**: аудио/видео обработка
- ✅ **FFprobe**: анализ медиа файлов  
- ✅ **Whisper CLI**: транскрипция аудио

#### 3. ПРОЕКТ И ЗАВИСИМОСТИ
- ✅ **package.json**: существование и структура скриптов
- ✅ **node_modules**: размер и доступность
- ✅ **dist/**: сборка production кода
- ✅ **tsconfig.json**: конфигурация TypeScript

#### 4. ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ (10 критичных ENV)
```bash
ENV_VARS=(
    "MEDIA_PORT"           # REST API порт
    "MEDIA_HOST"           # Хост сервера  
    "LOG_LEVEL"            # Уровень логирования
    "OUTPUT_DIR"           # Папка результатов
    "ASSETS_DIR"           # Папка ресурсов
    "PROJECT_ROOT"         # Корень проекта
    "KOKORO_TTS_URL"       # TTS сервис Kokoro
    "OPENAI_API_KEY"       # OpenAI ключ (скрывается)
    "OPENAI_BASE_URL"      # OpenAI endpoint
    "FONT_FILE"            # Путь к шрифту
)
```

#### 5. СЕТЬ И ПОРТЫ
- ✅ **Активные порты**: проверка 4123 (REST) и 5123 (MCP)
- ✅ **Сетевая доступность**: ping localhost
- ✅ **netstat**: анализ активных соединений

#### 6. ПРОЦЕССЫ И СЕРВИСЫ
- ✅ **Media-server процессы**: поиск через `ps aux`
- ✅ **Systemd сервисы**: проверка активности служб
- ✅ **PID информация**: мониторинг процессов

#### 7. HEALTH CHECKS HTTP
- ✅ **REST API Health**: `curl http://localhost:4123/api/health`
- ✅ **MCP Server Health**: `curl http://localhost:5123/api/health`  
- ✅ **Детальные ответы**: JSON ответы для verbose режима

#### 8. ФАЙЛОВАЯ СИСТЕМА
- ✅ **Критичные директории**:
  - `/app/output` (результаты)
  - `/root/media-video-maker_project` (проект)
  - `/root/CRIME MATERIAL` (контент)
- ✅ **Права доступа**: анализ разрешений через `stat -c "%a"`
- ✅ **Размеры папок**: `du -sh` для анализа использования
- ✅ **Шрифты**: проверка дефолтного шрифта DejaVu

#### 9. МОДУЛЬНЫЕ ТЕСТЫ
- ✅ **Папка тестов**: существование `tests/` директории
- ✅ **Исполняемость**: проверка chmod +x для скриптов
- ✅ **Тестовые скрипты**:
  - `run_all_tests.sh`
  - `test_subtitles.sh`
  - `test_voiceover.sh`  
  - `test_overlays.sh`
  - `test_music.sh`

#### 10. АНАЛИЗ ПРОБЛЕМ
- ✅ **Место на диске**: alert если менее 1GB свободно
- ✅ **Нагрузка памяти**: warning при >75%, error при >90%
- ✅ **Доступность сервиса**: проверка health endpoints
- ✅ **Подсчет ошибок**: итоговая оценка состояния

### ✅ ИНТЕГРАЦИЯ С npm

#### Новые скрипты в package.json:
```json
{
  "scripts": {
    "diagnostic": "./scripts/diagnostic.sh",
    "test": "./tests/run_all_tests.sh"
  }
}
```

#### Использование:
```bash
npm run diagnostic              # Обычная диагностика
npm run diagnostic -- --verbose # Детальная диагностика  
npm run test                    # Модульные тесты
```

### ✅ РЕЖИМЫ ВЫПОЛНЕНИЯ

#### Стандартный режим:
- Быстрая проверка ключевых компонентов
- Цветной вывод результатов
- Логирование в `logs/diagnostic.log`

#### Verbose режим (`--verbose`):
- Детальные JSON ответы health checks
- Расширенная информация о скриптах
- Дополнительные рекомендации по анализу

### ✅ ОБРАБОТКА ОШИБОК

#### Отказоустойчивость:
- `set -euo pipefail`: немедленный выход при ошибках
- Проверка существования команд перед вызовом
- Обходные пути при отсутствии инструментов

#### Безопасность:
- Скрытие ключей API в выводе
- Условная проверка чувствительных данных
- Graceful fallback при недоступности сервисов

### ✅ ЛОГИРОВАНИЕ И ОТЧЁТЫ

#### Цветная консоль (TEE выход):
- `[INFO]` - ГОЛУБОЙ: обычная информация
- `[WARN]` - ЖЁЛТЫЙ: предупреждения
- `[ERROR]` - КРАСНЫЙ: критические проблемы  
- `[OK]` - ЗЕЙЛЁНЫЙ: успешные проверки

#### Файл лога:
- Путь: `logs/diagnostic.log`
- Формат: timestamped events + результаты проверок
- Автоматическое создание папки `logs/`

#### Итоговый отчёт:
- Сводная статистика проблем
- Компоненты в статусе ✅/❌  
- Количество найденных проблем
- Путь к полному логу

### ✅ ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ

#### Рекомендации к действию:
- Команды для дополнительной диагностики (`npm run check`)
- Пути для запуска модульных тестов
- Endpoints для детального анализа системы

#### Расширяемость:
- Легко добавлять новые проверки в соответствующие секции
- Модульная структура позволяет отключать отдельные проверки
- Параметризованные порты и пути

## Применение на сервере

### Быстрая диагностика:
```bash
cd /root/media-video-maker_project/media-video-maker_server
./scripts/diagnostic.sh
```

### Мониторинг после изменений:
```bash  
npm run diagnostic
# Быстро проверить состояние после git pull/build
```

### Troubleshooting:
```bash
npm run diagnostic -- --verbose
# Детальный анализ для выявления проблем
```

## Интеграция с существующими рабочими процессами

### Перед деплоем:
```bash
npm run diagnostic  # Проверить готовность среды
npm run build       # Собрать код
npm start           # Запустить сервис
npm run test        # Проверить модули
```

### После инцидента:
```bash
npm run diagnostic -- --verbose  # Анализ проблемы
# Автоматическое обнаружение недоступности портов/процессов
# Проверка места на диске и памяти
```

## Статус задачи T37: ✅ ВЫПОЛНЕНО  
- ✅ Создан полнофункциональный скрипт диагностики
- ✅ Покрывает все компоненты системы (runtime, проект, сервисы)
- ✅ Интегрирован с npm скриптами
- ✅ Поддерживает стандартный и verbose режимы
- ✅ Включает анализ проблем и рекомендации
- ✅ Логирование с цветным выводом и файлами

## Следующие задачи:
- T38: Оценить производительность системы
- T39: Приоритезированный план работ P0/P1/P2
- T40: Финальный отчёт с выводами
